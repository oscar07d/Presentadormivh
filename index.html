<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Proyección de Letras</title>
  <!-- Cargamos algunas Google Fonts de ejemplo -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Estilos para la proyección */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background-color: #000;
    }
    #background-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: opacity 1s ease-in-out;
      z-index: 1;
    }
    #lyrics-container {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease-in-out;
    }
    /* Clase para ocultar de forma suave */
    #lyrics-container.hidden {
      opacity: 0;
    }
    #lyrics-text {
      font-size: 4vw;
      color: #fff;
      text-align: center;
      padding: 20px;
      transition: opacity 0.5s ease-in-out;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      /* Sin contenedor de fondo */
    }
  </style>
</head>
<body>
  <!-- Contenedor del fondo y de la letra -->
  <div id="background-container"></div>
  <div id="lyrics-container">
    <div id="lyrics-text">Carga un archivo RTF de letras...</div>
  </div>

  <script>
    /**************** Variables Globales ****************/
    let lyricLines = [];         // Arreglo con las líneas de la letra
    let currentLineIndex = 0;    // Línea actual mostrada
    let backgroundElement = null;  // Elemento (video/audio) usado como fondo (si corresponde)
    let backgroundType = null;   // "image", "video" o "audio"
    let controlPanelWindow = null; // Referencia al popup del panel de control

    /**************** Funciones de proyección ****************/
    function updateLyrics() {
      const lyricsTextElem = document.getElementById('lyrics-text');
      // Transición suave: se desvanece, se actualiza y reaparece
      lyricsTextElem.style.opacity = 0;
      setTimeout(() => {
        if (lyricLines.length > 0 && currentLineIndex >= 0 && currentLineIndex < lyricLines.length) {
          lyricsTextElem.textContent = lyricLines[currentLineIndex];
        }
        lyricsTextElem.style.opacity = 1;
      }, 500);
    }

    function nextLine() {
      if (currentLineIndex < lyricLines.length - 1) {
        currentLineIndex++;
        updateLyrics();
      }
    }

    function prevLine() {
      if (currentLineIndex > 0) {
        currentLineIndex--;
        updateLyrics();
      }
    }

    // Función modificada para ocultar/revelar con transición
    function toggleLyrics() {
      const lyricsContainer = document.getElementById('lyrics-container');
      lyricsContainer.classList.toggle('hidden');
    }

    function playPauseBackground() {
      if (backgroundElement && (backgroundType === 'video' || backgroundType === 'audio')) {
        if (backgroundElement.paused) {
          backgroundElement.play();
        } else {
          backgroundElement.pause();
        }
      }
    }

    function muteToggleBackground() {
      if (backgroundElement && (backgroundType === 'video' || backgroundType === 'audio')) {
        backgroundElement.muted = !backgroundElement.muted;
      }
    }

    /**************** Funciones para cargar archivos ****************/
    function loadRTFFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const plainText = parseRTF(content);
        // Separamos el texto en líneas (filtrando las vacías)
        lyricLines = plainText.split(/\r?\n/).filter(line => line.trim() !== "");
        currentLineIndex = 0;
        updateLyrics();
      }
      reader.readAsText(file, 'UTF-8');
    }

    // Función básica para convertir RTF a texto plano (no es un parser completo)
    function parseRTF(rtf) {
      // Convierte secuencias como \'e1 a su carácter correspondiente
      let text = rtf.replace(/\\'([0-9a-fA-F]{2})/g, function(match, hex) {
        return String.fromCharCode(parseInt(hex, 16));
      });
      // Elimina grupos y palabras de control (de forma muy básica)
      text = text.replace(/{\\[^}]+}/g, '');
      text = text.replace(/\\[a-zA-Z]+\d* ?/g, '');
      text = text.replace(/[{}]/g, '');
      return text;
    }

    function loadBackgroundFile(file) {
      const url = URL.createObjectURL(file);
      const container = document.getElementById('background-container');
      // Transición de salida
      container.style.opacity = 0;
      setTimeout(() => {
        container.innerHTML = '';
        if (file.type.startsWith('image/')) {
          backgroundType = 'image';
          backgroundElement = null;
          container.style.backgroundImage = `url(${url})`;
          container.style.backgroundSize = 'cover';
          container.style.backgroundPosition = 'center';
        } else if (file.type.startsWith('video/')) {
          backgroundType = 'video';
          const video = document.createElement('video');
          video.src = url;
          video.autoplay = true;
          video.loop = true;
          video.muted = false;
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          container.appendChild(video);
          backgroundElement = video;
          container.style.backgroundImage = 'none';
        } else if (file.type.startsWith('audio/')) {
          backgroundType = 'audio';
          const audio = document.createElement('audio');
          audio.src = url;
          audio.autoplay = true;
          audio.loop = true;
          audio.controls = false;
          container.style.backgroundColor = '#000';
          backgroundElement = audio;
        } else {
          alert('Tipo de archivo no soportado para el fondo.');
        }
        // Transición de entrada
        container.style.opacity = 1;
      }, 1000);
    }

    /**************** Apertura del Panel de Control (Popup) ****************/
    // Abrir el panel al presionar Ctrl+Shift+Y
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === 'Y') {
        e.preventDefault();
        openControlPanel();
      }
    });

    function openControlPanel() {
      if (controlPanelWindow && !controlPanelWindow.closed) {
        controlPanelWindow.focus();
        return;
      }
      controlPanelWindow = window.open('', 'ControlPanel', 'width=450,height=850,resizable=yes');
      if (!controlPanelWindow) {
        alert('Bloqueador de pop-ups activo. Por favor, permite pop-ups para este sitio.');
        return;
      }
      // Se escribe el HTML del panel en el popup con secciones separadas y estilos mejorados
      controlPanelWindow.document.write(`
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #3b3b3b, #1f1f1f);
      color: #fff;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
    }
    h1 {
      margin-bottom: 30px;
      font-size: 2em;
    }
    .section {
      margin-bottom: 30px;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 8px;
    }
    .section h2 {
      margin-top: 0;
      font-size: 1.4em;
      border-bottom: 1px solid #555;
      padding-bottom: 5px;
    }
    .button-container {
      display: flex;
      justify-content: space-around;
      margin: 15px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      background-color: #5a5a5a;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #7a7a7a;
    }
    .file-input,
    .font-select,
    .font-size-control {
      text-align: center;
      margin: 15px 0;
    }
    label {
      font-size: 1em;
      cursor: pointer;
    }
    input[type="file"],
    select,
    input[type="range"] {
      margin-top: 5px;
      padding: 5px;
      font-size: 1em;
      width: 80%;
      max-width: 300px;
    }
    /* Estilos para el slider en Chrome */
    input[type="range"] {
      -webkit-appearance: none;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      margin-top: -7px;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 8px;
      background: #5a5a5a;
      border-radius: 5px;
    }
    #preview {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #555;
      border-radius: 5px;
      background-color: #222;
      min-height: 80px;
      font-size: 1.2em;
      line-height: 1.4em;
      overflow-y: auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Panel de Control</h1>
  
  <div class="section">
    <h2>Navegación y Control</h2>
    <div class="button-container">
      <button id="prevLineBtn">Anterior</button>
      <button id="nextLineBtn">Siguiente</button>
      <button id="toggleLyricsBtn">Ocultar/Revelar Letras</button>
    </div>
    <div class="button-container">
      <button id="playPauseBtn">Play/Pausa Fondo</button>
      <button id="muteBtn">Mutear/Activar Sonido</button>
    </div>
  </div>
  
  <div class="section">
    <h2>Carga de Archivos</h2>
    <div class="file-input">
      <label>Cargar archivo RTF de letras:<br>
        <input type="file" id="rtfInput" accept=".rtf">
      </label>
    </div>
    <div class="file-input">
      <label>Cargar fondo (imagen, video, audio):<br>
        <input type="file" id="bgInput" accept="image/*,video/*,audio/*">
      </label>
    </div>
  </div>
  
  <div class="section">
    <h2>Personalización de Texto</h2>
    <div class="font-select">
      <label>Seleccionar fuente para las letras:<br>
        <select id="fontSelect">
          <option value="'Roboto', sans-serif">Roboto</option>
          <option value="'Open Sans', sans-serif">Open Sans</option>
          <option value="'Lato', sans-serif">Lato</option>
          <option value="'Montserrat', sans-serif">Montserrat</option>
          <option value="'Oswald', sans-serif">Oswald</option>
        </select>
      </label>
    </div>
    <div class="font-size-control">
      <label>Ajustar tamaño del texto:<br>
        <input type="range" id="fontSizeSlider" min="2" max="10" step="0.1" value="4">
      </label>
      <div style="text-align:center;">Tamaño: <span id="fontSizeValue">4vw</span></div>
    </div>
  </div>
  
  <div class="section">
    <h2>Previsualización</h2>
    <div id="preview">No hay previsualización</div>
  </div>
  
  <script>
    const openerWindow = window.opener;
    document.getElementById('prevLineBtn').addEventListener('click', () => {
      if (openerWindow && openerWindow.prevLine) {
        openerWindow.prevLine();
      }
    });
    document.getElementById('nextLineBtn').addEventListener('click', () => {
      if (openerWindow && openerWindow.nextLine) {
        openerWindow.nextLine();
      }
    });
    document.getElementById('toggleLyricsBtn').addEventListener('click', () => {
      if (openerWindow && openerWindow.toggleLyrics) {
        openerWindow.toggleLyrics();
      }
    });
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (openerWindow && openerWindow.playPauseBackground) {
        openerWindow.playPauseBackground();
      }
    });
    document.getElementById('muteBtn').addEventListener('click', () => {
      if (openerWindow && openerWindow.muteToggleBackground) {
        openerWindow.muteToggleBackground();
      }
    });
    document.getElementById('rtfInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && openerWindow && openerWindow.loadRTFFile) {
        openerWindow.loadRTFFile(file);
      }
    });
    document.getElementById('bgInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && openerWindow && openerWindow.loadBackgroundFile) {
        openerWindow.loadBackgroundFile(file);
      }
    });
    document.getElementById('fontSelect').addEventListener('change', (e) => {
      const font = e.target.value;
      if (openerWindow) {
        const lyricsText = openerWindow.document.getElementById('lyrics-text');
        if (lyricsText) {
          lyricsText.style.fontFamily = font;
        }
      }
    });
    // Evento para la barra deslizante que ajusta el tamaño del texto
    document.getElementById('fontSizeSlider').addEventListener('input', (e) => {
      const newSize = e.target.value;
      if (openerWindow) {
        const lyricsText = openerWindow.document.getElementById('lyrics-text');
        if (lyricsText) {
          lyricsText.style.fontSize = newSize + 'vw';
        }
      }
      document.getElementById('fontSizeValue').textContent = newSize + 'vw';
    });
    
    // Actualiza la previsualización de la letra (solo texto) cada 500ms
    function updatePreview() {
      if (openerWindow && !openerWindow.closed) {
        const previewDiv = document.getElementById('preview');
        const lyricElem = openerWindow.document.getElementById('lyrics-text');
        previewDiv.textContent = lyricElem ? lyricElem.textContent : 'No disponible';
      }
    }
    setInterval(updatePreview, 500);
  <\/script>
</body>
</html>
      `);
      controlPanelWindow.document.close();
    }

    /**************** Exponemos las funciones para usarlas desde el panel ****************/
    window.nextLine = nextLine;
    window.prevLine = prevLine;
    window.toggleLyrics = toggleLyrics;
    window.playPauseBackground = playPauseBackground;
    window.muteToggleBackground = muteToggleBackground;
    window.loadRTFFile = loadRTFFile;
    window.loadBackgroundFile = loadBackgroundFile;
  </script>
</body>
</html>
